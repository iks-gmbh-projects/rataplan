<div class="center">
  <div
    class="content"
    *ngrxLet="{survey: survey$, answers: answers$, columns: tableColumns$, charts: charts$, busy: busy$, delayedBusy: delayedBusy$} as state"
  >
    <ng-template #loading>
      <mat-spinner *ngIf="state.delayedBusy"/>
    </ng-template>
    <div
      class="width"
      *ngIf="!state.busy; else loading"
    >
      <h2 [textContent]="state.survey.name"></h2>
      <div class="bottomspace" *ngFor="let group of state.survey.questionGroups">
        <h4 [textContent]="group.title"></h4>
        <div class="bottomspace" *ngFor="let question of group.questions">
          <mat-expansion-panel *ngIf="question.rank !== undefined">
            <mat-expansion-panel-header>
              <mat-panel-title [textContent]="question.text"/>
            </mat-expansion-panel-header>
            <ng-template matExpansionPanelContent>
              @if (state.charts[group.id!]?.[question.rank]; as datum) {
                <app-survey-result-charts [question]="question" [charts]="datum"/>
              }
              <div class="mat-table" *ngIf="state.columns[group.id!]?.[question.rank] as columns">
                <table mat-table matSort [dataSource]="state.answers">
                  <ng-container matColumnDef="user">
                    <th mat-header-cell mat-sort-header *matHeaderCellDef>Beantworter</th>
                    <td
                      mat-cell
                      *matCellDef="let answer"
                      [textContent]="(answer.userId | displayName | async) || 'Anonym'"
                    ></td>
                  </ng-container>
                  @switch (question.type) {
                    @case ('CHOICE') {
                      <ng-container
                        *ngFor="let checkbox of question.choices"
                        [matColumnDef]="'checkbox'+checkbox.id!"
                      >
                        <th mat-header-cell mat-sort-header *matHeaderCellDef>
                          <div>
                            <div [textContent]="checkbox.text"></div>
                            <div>
                              <span [textContent]="checkboxPercentage(group.id!, question.rank, checkbox.id!, state.answers) | number : '1.0-1'"></span>%
                            </div>
                          </div>
                        </th>
                        <td mat-cell *matCellDef="let answer">
                          <mat-icon [textContent]="toCheckbox(answer.answers[group.id!]?.[question.rank]?.checkboxes?.[checkbox.id!])">
                          </mat-icon>
                        </td>
                      </ng-container>
                    }
                    @case ('ORDER') {
                      <ng-container *ngrxLet="orderRanking(group.id!, question.rank, state.answers) as ranking">
                        <ng-container
                          *ngFor="let checkbox of question.choices"
                          [matColumnDef]="'checkbox'+checkbox.id!"
                        >
                          <th mat-header-cell mat-sort-header *matHeaderCellDef>
                            <div>
                              <div [textContent]="checkbox.text"></div>
                              <div>
                                <span [textContent]="ranking[checkbox.id!] ?? '?'"></span>.
                              </div>
                            </div>
                          </th>
                          <td mat-cell *matCellDef="let answer">
                            <div>
                              <span [textContent]="answer.answers[group.id!]?.[question.rank]?.order?.indexOf(checkbox.id)+1"></span>.
                            </div>
                          </td>
                        </ng-container>
                      </ng-container>
                    }
                  }
                  <ng-container *ngIf="hasTextfield(question)" matColumnDef="answer">
                    <th mat-header-cell mat-sort-header *matHeaderCellDef> Freitextantwort</th>
                    <td
                      mat-cell
                      *matCellDef="let answer"
                      [textContent]="answer.answers[group.id!]?.[question.rank]?.text"
                    ></td>
                  </ng-container>
                  <tr mat-header-row *matHeaderRowDef="columns"></tr>
                  <tr mat-row *matRowDef="let row; columns: columns"></tr>
                </table>
              </div>
            </ng-template>
          </mat-expansion-panel>
        </div>
      </div>
    </div>
    <div class="button">
      <a mat-raised-button color="primary" routerLink="..">Zur√ºck</a>
      <button
        mat-icon-button
        color="primary"
        (click)="downloadResults()"
      >
        <mat-icon id="icon">download</mat-icon>
      </button>
    </div>
  </div>
</div>