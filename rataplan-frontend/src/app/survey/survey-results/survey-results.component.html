<div class="center">
  <div
    class="content"
    *ngrxLet="{survey: survey$, answers: answers$, columns: tableColumns$, charts: charts$, busy: busy$, delayedBusy: delayedBusy$} as state"
  >
    <ng-template #loading>
      <mat-spinner *ngIf="state.delayedBusy"/>
    </ng-template>
    <div
      class="width"
      *ngIf="!state.busy; else loading"
    >
      <h2 [textContent]="state.survey.name"></h2>
      <div class="bottomspace" *ngFor="let group of state.survey.questionGroups">
        <h4>{{ group.title }}</h4>
        <div class="bottomspace" *ngFor="let question of group.questions">
          <mat-expansion-panel *ngIf="question.rank !== undefined">
            <mat-expansion-panel-header>
              <mat-panel-title>{{ question.text }}</mat-panel-title>
            </mat-expansion-panel-header>
            <canvas
              *ngIf="state.charts[group.id!]?.[question.rank] as datum"
              baseChart
              type="pie"
              [data]="datum"
            ></canvas>
            <div class="mat-table" *ngIf="state.columns[group.id!]?.[question.rank] as columns">
              <table mat-table matSort [dataSource]="state.answers">
                <ng-container matColumnDef="user">
                  <th mat-header-cell mat-sort-header *matHeaderCellDef>Beantworter</th>
                  <td
                    mat-cell
                    *matCellDef="let answer"
                  >{{ (answer.userId | displayName | async) || "Anonym" }}
                  </td>
                </ng-container>
                <ng-container [ngSwitch]="question.type">
                  <ng-template [ngSwitchCase]="'CHOICE'">
                    <ng-container
                      *ngFor="let checkbox of question.choices"
                      [matColumnDef]="'checkbox'+checkbox.id!"
                    >
                      <th mat-header-cell mat-sort-header *matHeaderCellDef>
                        <div>
                          <div [textContent]="checkbox.text"></div>
                          <div>
                            <span [textContent]="checkboxPercentage(group.id!, question.rank, checkbox.id!, state.answers) | number : '1.0-1'"></span>%
                          </div>
                        </div>
                      </th>
                      <td mat-cell *matCellDef="let answer">
                        <mat-icon [textContent]="toCheckbox(answer.answers[group.id!]?.[question.rank]?.checkboxes?.[checkbox.id!])">
                        </mat-icon>
                      </td>
                    </ng-container>
                  </ng-template>
                  <ng-container *ngIf="hasTextfield(question)" matColumnDef="answer">
                    <th mat-header-cell mat-sort-header *matHeaderCellDef> Freitextantwort</th>
                    <td
                      mat-cell
                      *matCellDef="let answer"
                      [textContent]="answer.answers[group.id!]?.[question.rank]?.text"
                    ></td>
                  </ng-container>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="columns"></tr>
                <tr mat-row *matRowDef="let row; columns: columns"></tr>
              </table>
            </div>
          </mat-expansion-panel>
        </div>
      </div>
    </div>
    <div class="button">
      <a mat-raised-button color="primary" routerLink="..">Zur√ºck</a>
      <button
        mat-icon-button
        color="primary"
        (click)="downloadResults()"
      >
        <mat-icon id="icon">download</mat-icon>
      </button>
    </div>
  </div>
</div>