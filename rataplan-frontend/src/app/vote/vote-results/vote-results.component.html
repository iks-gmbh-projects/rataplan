<div class="wrapper" *ngIf="vote">
  <div class="result-header-container" style="margin-bottom: 20px">
    <div class="result-header">
      <div class="result-title" [textContent]="vote.title"> </div>
      <div class="result-subtitle">
        Abstimmung aktiv bis: {{ vote.deadline | date:'dd. MMMM yyyy hh:mm':undefined:'de' }}
      </div>
      <div class="result-subtitle" *ngIf="hasDeadlinePassed()">
        <span class="mat-error">Die Abstimmung ist abgelaufen. Eine Teilnahme ist nicht mehr m√∂glich</span>
      </div>
    </div>
    <div class="result-content">
      <p class="linebreak-p-tag"> {{ vote.description ?? ''}}</p>
    </div>
    <div class="result-footer">
      <div *ngIf="vote.organizerName">
        <span>Erstellt von {{ vote.organizerName }}</span>
      </div>
    </div>
  </div>
  <div class="result-container">
    <div class="filter-options">
      <div>
        <mat-form-field>
          <mat-label>Filtern nach</mat-label>
          <mat-select [(ngModel)]="filterByOption" [disabled]="!tableView">
            <mat-option
              *ngFor="let filterBy of FilterByOptions | keyvalue"
              (click)="updateFilterOptions(filterBy.value)"
              [value]="filterBy.value"
            >
              {{ filterBy.value }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field *ngIf="filterByOption !== FilterByOptions.PARTICIPANT">
          <mat-label>Termin</mat-label>
          <mat-select [(ngModel)]="filterVoteOption" [disabled]="!tableView">
            <mat-option *ngFor="let v of vote.options;let i = index" [value]="i">
              Termin {{ i + 1 }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field *ngIf="filterByOption === FilterByOptions.VOTE_OPTION; else sortByNameDropDownOptions">
          <mat-label>Sortieren</mat-label>
          <mat-select [(ngModel)]="filterSortOption" [disabled]="!tableView">
            <mat-option
              *ngFor="let sortOption of VoteAnswerFilterOptions | keyvalue"
              [value]="sortOption.value"
            >{{ sortOption.value }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <ng-template #sortByNameDropDownOptions>
          <mat-form-field>
            <mat-label>Sortieren</mat-label>
            <mat-select [(ngModel)]="filterSortOption" [disabled]="!tableView">
              <mat-option
                *ngFor="let sortOption of GeneralFilterSortOption | keyvalue"
                [value]="sortOption.value"
              >{{ sortOption.value }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </ng-template>
      </div>
      <!--        <div style="margin-bottom: 10px">-->
      <button
        mat-raised-button
        [disabled]="!filterByOption || !filterSortOption || filterVoteOption === undefined || filterVoteOption < 0 || filterVoteOption > vote.options.length "
        color="primary"
        (click)="applyFilter()"
        style="margin-right: 15px"
      >Anwenden
      </button>
      <button
        mat-raised-button
        color="primary"
        (click)="tableView = !tableView"
        *ngIf="vote.voteConfig.decisionType !== DecisionType.NUMBER"
        style="margin-right: 15px"
      >
        <mat-icon>
          {{ tableView ? 'pie_chart' : 'table_chart' }}
        </mat-icon>
      </button>
      <button mat-raised-button class="back-to-vote-button" [routerLink]="['../']">Zur Abstimmung</button>
      <!--        </div>-->
    </div>
    <div>
      <table *ngIf="tableView; else pieChart" #resultsTable style="margin-bottom: 1rem">
        <thead>
        <tr>
          <th class="participant-column-title">Teilnehmer</th>
          <th *ngFor="let voteOption of vote.options; let i = index">
            <span>Option {{ i + 1 }}</span>
            <mat-icon (click)="showVoteOptionInfo(voteOption)">info</mat-icon>
          </th>
        </tr>
        </thead>
        <tbody *ngIf="vote.voteConfig.decisionType !== DecisionType.NUMBER; else teilnehmerVote">
        <tr *ngFor="let userResults of allVoteResults; let i = index">
          <td class="username-result-entries">{{ userResults.username }}</td>
          <ng-container
            [ngSwitch]="userResults.decisions[vo.id!]"
            *ngFor="let vo of vote.options"
          >
            <td *ngSwitchCase="0"><p>Keine Antwort</p></td>
            <td *ngSwitchCase="1" class="accepted-option"><p>Akzeptiert</p></td>
            <td *ngSwitchCase="2" class="maybe-option"><p>Vielleicht</p></td>
            <td *ngSwitchCase="3" class="rejected-option"><p>Abgelehnt</p></td>
          </ng-container>
        </tr>
        <tr>
          <td class="username-result-entries">Ergebnis</td>
          <td *ngFor="let voteOption of vote.options!">
            <p>{{ getVoteOptionSum(voteOption.id!) }}</p>
          </td>
        </tr>
        </tbody>
        <ng-template #teilnehmerVote>
          <tbody>
          <tr *ngFor="let userResults of allVoteResults; let i = index">
            <td class="username-result-entries" [textContent]="userResults.username"></td>
            <ng-container
              [ngSwitch]="userResults.decisions[vo.id!]"
              *ngFor="let vo of vote.options"
            >
              <td *ngSwitchCase="0" class="rejected-option"><p>0</p></td>
              <td *ngSwitchDefault class="accepted-option" [textContent]="userResults.decisions[vo.id!]"></td>
            </ng-container>
          </tr>
          <tr>
            <td class="username-result-entries">Ergebnis</td>
            <td *ngFor="let voteOption of vote.options!" [textContent]="getVoteOptionSum(voteOption.id!)">
            </td>
          </tr>
          </tbody>
        </ng-template>
      </table>
    </div>
    <button mat-mini-fab *ngIf="tableView" color="primary" style="float: right" (click)="createExcel()">
      <mat-icon>download</mat-icon>
    </button>
    <ng-template #pieChart>
      <div style="display: flex;">
        <div style="justify-content: flex-start; flex-direction: row">
          <div
            *ngFor="let option of vote.options"
            style="margin-bottom: 10vw"
          >
            <p *ngIf="option.startDate">{{ option.endDate ? 'Start' : option.startDate ? 'Zeit' : 'Datum' }}
              : {{ option.startDate| date:'dd.MM.yyyy' + (option.startDate ? ' HH:mm' : ''): undefined: 'de' }}</p>
            <p *ngIf="option.endDate">
              Ende: {{ option.endDate | date:'dd.MM.yyyy' + (option.startDate ? ' HH:mm' : ''): undefined: 'de' }}</p>
            <p *ngIf="option.description">Beschreibung: {{ option.description }}</p>
            <p *ngIf="option.url">url: <a [href]="option.url" [textContent]="option.url"></a></p>
            <div style="min-width: 75%;">
              <canvas
                style="max-height: 35vh"
                baseChart
                type="pie"
                [data]="pieChartResults[option.id!]"
              ></canvas>
              <p>Ja: {{ rawResults?.[option.id!]?.[VoteOptionDecisionType.ACCEPT] ?? 0 }}</p>
              <p *ngIf="rawResults?.[option.id!]?.[VoteOptionDecisionType.ACCEPT_IF_NECESSARY]">
                Vielleicht: {{ rawResults?.[option.id!]?.[VoteOptionDecisionType.ACCEPT_IF_NECESSARY] }}</p>
              <p>Nein: {{ rawResults?.[option.id!]?.[VoteOptionDecisionType.DECLINE] }}</p>
              <p *ngIf="rawResults?.[option.id!]?.[VoteOptionDecisionType.NO_ANSWER]">
                Keine Antwort: {{ rawResults?.[option.id!]?.[VoteOptionDecisionType.NO_ANSWER] }}</p>
              <b>Gesamt: {{ getVoteOptionSum(option.id!) }}</b>
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </div>
</div>