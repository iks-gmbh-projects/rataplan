<div class="wrapper">
  <div style="margin-bottom: 20px">
    <mat-card>
      <mat-card-header>
        <mat-card-title [textContent]="vote.title"></mat-card-title>
        <mat-card-subtitle>
          Abstimmung aktiv bis: {{ vote.deadline | date:'dd. MMMM yyyy hh:mm':undefined:'de' }}
        </mat-card-subtitle>
        <mat-card-subtitle *ngIf="hasDeadlinePassed()">
          <span class="mat-error">Die Abstimmung ist abgelaufen. Eine Teilnahme ist nicht mehr m√∂glich</span>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <p [textContent]="vote.description ?? ''"></p>
      </mat-card-content>
      <mat-card-footer>
        <div *ngIf="vote.organizerName">
          <span>Erstellt von {{ vote.organizerName }}</span>
        </div>
      </mat-card-footer>
    </mat-card>
  </div>
  <mat-card class="result-container">
    <mat-card-content>
      <div style="margin-bottom: 1rem">
        <div>
          <mat-form-field>
            <mat-label>Filtern nach</mat-label>
            <mat-select [(ngModel)]="filterByOption" [disabled]="!tableView">
              <mat-option
                *ngFor="let filterBy of FilterByOptions | keyvalue"
                (click)="updateFilterOptions(filterBy.value)"
                [value]="filterBy.value"
              >
                {{ filterBy.value }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field *ngIf="filterByOption !== FilterByOptions.PARTICIPANT">
            <mat-label>Termin</mat-label>
            <mat-select [(ngModel)]="filterVoteOption" [disabled]="!tableView">
              <mat-option *ngFor="let v of vote.options;let i = index" [value]="i">
                Termin {{ i + 1 }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field *ngIf="filterByOption === FilterByOptions.VOTE_OPTION; else sortByNameDropDownOptions">
            <mat-label>Sortieren</mat-label>
            <mat-select [(ngModel)]="filterSortOption" [disabled]="!tableView">
              <mat-option
                *ngFor="let sortOption of VoteAnswerFilterOptions | keyvalue"
                [value]="sortOption.value"
              >{{ sortOption.value }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <ng-template #sortByNameDropDownOptions>
            <mat-form-field>
              <mat-label>Sortieren</mat-label>
              <mat-select [(ngModel)]="filterSortOption" [disabled]="!tableView">
                <mat-option
                  *ngFor="let sortOption of GeneralFilterSortOption | keyvalue"
                  [value]="sortOption.value"
                >{{ sortOption.value }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </ng-template>
        </div>
        <!--        <div style="margin-bottom: 10px">-->
        <button
          mat-raised-button
          [disabled]="!filterByOption || !filterSortOption || filterVoteOption === undefined || filterVoteOption < 0 || filterVoteOption > vote.options.length "
          color="primary"
          (click)="applyFilter()"
          style="margin-right: 15px"
        >Anwenden
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="tableView = !tableView"
          *ngIf="vote.voteConfig.decisionType !== DecisionType.NUMBER"
          style="margin-right: 15px"
        >
          <mat-icon>
            {{ tableView ? 'pie_chart' : 'table_chart' }}
          </mat-icon>
        </button>
        <button mat-raised-button class="back-to-vote-button" [routerLink]="['../']">Zur Abstimmung</button>
        <!--        </div>-->
      </div>
      <table *ngIf="tableView; else pieChart" #resultsTable style="margin-bottom: 1rem">
        <thead>
        <tr>
          <th class="participant-column-title">Teilnehmer</th>
          <th *ngFor="let voteOption of vote.options; let i = index">
            <span>Option {{ i + 1 }}</span>
            <mat-icon (click)="showVoteOptionInfo(voteOption)">info</mat-icon>
          </th>
        </tr>
        </thead>
        <tbody *ngIf="vote.voteConfig.decisionType !== DecisionType.NUMBER; else teilnehmerVote">
        <tr *ngFor="let userResults of allVoteResults; let i = index">
          <td class="username-result-entries">{{ userResults.username }}</td>
          <ng-container
            [ngSwitch]="userResults.voteOptionAnswers.get(vo.id!)"
            *ngFor="let vo of vote.options"
          >
            <td *ngSwitchCase="0"><p>Keine Antwort</p></td>
            <td *ngSwitchCase="1" class="accepted-option"><p>Akzeptiert</p></td>
            <td *ngSwitchCase="2" class="maybe-option"><p>Vielleicht</p></td>
            <td *ngSwitchCase="3" class="rejected-option"><p>Abgelehnt</p></td>
          </ng-container>
        </tr>
        <tr>
          <td class="username-result-entries">Ergebnis</td>
          <td *ngFor="let voteOption of vote.options!">
            <p>{{ getVoteOptionSum(voteOption.id!) }}</p>
          </td>
        </tr>
        </tbody>
        <ng-template #teilnehmerVote>
          <tbody>
          <tr *ngFor="let userResults of allVoteResults; let i = index">
            <td class="username-result-entries">{{ userResults.username }}</td>
            <ng-container
              [ngSwitch]="userResults.voteOptionAnswers.get(vo.id!)"
              *ngFor="let vo of vote.options"
            >
              <td *ngSwitchCase="0" class="rejected-option"><p>0</p></td>
              <td *ngSwitchDefault class="accepted-option">
                <p>{{ userResults.voteOptionAnswers.get(vo.id!) }}</p></td>
            </ng-container>
          </tr>
          <tr>
            <td class="username-result-entries">Ergebnis</td>
            <td *ngFor="let voteOption of vote.options!">
              <p>{{ getVoteOptionSum(voteOption.id!) }}</p>
            </td>
          </tr>
          </tbody>
        </ng-template>
      </table>
      <button mat-mini-fab *ngIf="tableView" color="primary" style="float: right" (click)="createExcel()">
        <mat-icon>download</mat-icon>
      </button>
      <ng-template #pieChart style="overflow-x: scroll; scrollbar-width: thin">
        <div style="display: flex; flex-direction: row;">
          <div
            style="display: flex; align-content: center; justify-content: center; flex-direction: column; text-align: center;min-width: 100%"
            *ngFor="let option of vote.options"
          >
            <p *ngIf="option.startDate">{{ option.endDate ? 'Start' : option.startDate ? 'Zeit' : 'Datum' }}
              : {{ option.startDate| date:'dd.MM.yyyy' + (option.startDate ? ' HH:mm' : ''): undefined: 'de' }}</p>
            <p *ngIf="option.endDate">
              Ende: {{ option.endDate | date:'dd.MM.yyyy' + (option.startDate ? ' HH:mm' : ''): undefined: 'de' }}</p>
            <p *ngIf="option.description">Beschreibung: {{ option.description }}</p>
            <p *ngIf="option.url">url: <a [href]="option.url" [textContent]="option.url"></a></p>
            <div style="min-width: 75%;">
              <canvas
                style="max-height: 35vh"
                baseChart
                type="pie"
                [data]="pieChartResults[option.id!]"
              ></canvas>
              <p>Ja: {{ (rawResults[option.id!] ?? [0, 0, 0, 0])[VoteOptionDecisionType.ACCEPT] }}</p>
              <p *ngIf="(rawResults[option.id!] ?? [0, 0, 0, 0])[VoteOptionDecisionType.ACCEPT_IF_NECESSARY]">
                Vielleicht: {{ (rawResults[option.id!] ?? [0, 0, 0, 0])[VoteOptionDecisionType.ACCEPT_IF_NECESSARY] }}</p>
              <p>Nein: {{ (rawResults[option.id!] ?? [0, 0, 0, 0])[VoteOptionDecisionType.DECLINE] }}</p>
              <p *ngIf="(rawResults[option.id!] ?? [0, 0, 0, 0])[VoteOptionDecisionType.NO_ANSWER]">
                Keine Antwort: {{ (rawResults[option.id!] ?? [0, 0, 0, 0])[VoteOptionDecisionType.NO_ANSWER] }}</p>
              <b>Gesamt: {{ getVoteOptionSum(option.id!) }}</b>
            </div>
          </div>
        </div>
      </ng-template>
    </mat-card-content>
  </mat-card>
</div>